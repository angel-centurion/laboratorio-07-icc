events {
    worker_connections 1024;
}

http {
    charset utf-8;
    source_charset utf-8;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    upstream clientes-backend {
        server host.docker.internal:8081;
    }

    upstream productos-backend {
        server host.docker.internal:8082;
    }

    upstream proveedores-backend {
        server host.docker.internal:8083;
    }

    server {
        listen 80;
        add_header Content-Type "text/html; charset=utf-8" always;

        # P谩gina de inicio
        location = / {
            add_header Content-Type "text/html; charset=utf-8";
            return 200 '
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Laboratorio 07 - Balanceador</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                        .container { max-width: 800px; margin: 0 auto; text-align: center; }
                        h1 { margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
                        .app-link { display: block; background: rgba(255,255,255,0.2); padding: 20px; margin: 15px 0; border-radius: 10px;
                                    text-decoration: none; color: white; font-size: 18px; font-weight: bold; transition: all 0.3s; backdrop-filter: blur(10px); }
                        .app-link:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1> Laboratorio 07 - Sistema CRUD</h1>
                        <p>Balanceador de carga con Nginx</p>
                        <a href="/clientes" class="app-link"> Gesti贸n de Clientes</a>
                        <a href="/productos" class="app-link"> Gesti贸n de Productos</a>
                        <a href="/proveedores" class="app-link"> Gesti贸n de Proveedores</a>
                    </div>
                </body>
                </html>
            ';
        }

        # CLIENTES - Configuraci贸n mejorada
        location ^~ /clientes {
            # Frontend
            location /clientes/$ {
                proxy_pass http://clientes-backend/;
            }
            location /clientes {
                proxy_pass http://clientes-backend/;
            }
            # API - capturar todas las rutas de API
            location ~ ^/clientes/api/(.*)$ {
                proxy_pass http://clientes-backend/api/$1$is_args$args;
            }
            # Archivos est谩ticos (CSS, JS, etc.)
            location ~ ^/clientes/(.*\.(css|js|png|jpg|ico))$ {
                proxy_pass http://clientes-backend/$1;
            }

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept-Charset "utf-8";
        }

        # PRODUCTOS - Configuraci贸n mejorada
        location ^~ /productos {
            # Frontend
            location /productos/$ {
                proxy_pass http://productos-backend/;
            }
            location /productos {
                proxy_pass http://productos-backend/;
            }
            # API
            location ~ ^/productos/api/(.*)$ {
                proxy_pass http://productos-backend/api/$1$is_args$args;
            }
            # Archivos est谩ticos
            location ~ ^/productos/(.*\.(css|js|png|jpg|ico))$ {
                proxy_pass http://productos-backend/$1;
            }

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept-Charset "utf-8";
        }

        # PROVEEDORES - Configuraci贸n mejorada
        location ^~ /proveedores {
            # Frontend
            location /proveedores/$ {
                proxy_pass http://proveedores-backend/;
            }
            location /proveedores {
                proxy_pass http://proveedores-backend/;
            }
            # API
            location ~ ^/proveedores/api/(.*)$ {
                proxy_pass http://proveedores-backend/api/$1$is_args$args;
            }
            # Archivos est谩ticos
            location ~ ^/proveedores/(.*\.(css|js|png|jpg|ico))$ {
                proxy_pass http://proveedores-backend/$1;
            }

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Accept-Charset "utf-8";
        }

        # Health checks
        location /health {
            add_header Content-Type "application/json; charset=utf-8";
            return 200 '{"status": "OK", "timestamp": "$time_iso8601", "service": "nginx-balancer"}';
        }
    }
}